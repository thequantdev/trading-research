//@version=6
// ============================================================================
// EFFICIENCY RATIO REGIME DETECTOR - TradingView Pine Script v5
// ============================================================================

//@indicator=Regime ER Detector
indicator("ER Regime Detector", overlay=true, max_labels_count=500)

// ============================================================================
// INPUTS
// ============================================================================
er_period = input.int(20, "Efficiency Ratio Period", minval=5, maxval=100)
show_signals = input.bool(true, "Show Trade Signals")
show_table = input.bool(true, "Show Statistics Table")

// ============================================================================
// EFFICIENCY RATIO CALCULATION
// ============================================================================
direction = math.abs(close - close[er_period])

volatility = 0.0
for i = 1 to er_period
    volatility := volatility + math.abs(close[i] - close[i-1])

er = volatility > 0 ? direction / volatility : 0

// ============================================================================
// REGIME CLASSIFICATION
// ============================================================================
regime = er > 0.7 ? "Strong Trend" : 
         er > 0.5 ? "Weak Trend" : 
         er > 0.3 ? "Transitioning" : "Choppy Range"

regime_color = er > 0.7 ? color.new(color.green, 0) :
               er > 0.5 ? color.new(color.lime, 30) :
               er > 0.3 ? color.new(color.yellow, 50) :
               color.new(color.red, 30)

// ============================================================================
// SIGNALS
// ============================================================================
high_20 = ta.highest(high, 20)
low_20 = ta.lowest(low, 20)

momentum_long = ta.crossover(close, high_20[1])
momentum_short = ta.crossunder(close, low_20[1])

[sma_20, upper_bb, lower_bb] = ta.bb(close, 20, 2)

mr_long = ta.crossunder(close, lower_bb)
mr_short = ta.crossover(close, upper_bb)

valid_long = (er > 0.5 and momentum_long) or (er < 0.3 and mr_long)
valid_short = (er > 0.5 and momentum_short) or (er < 0.3 and mr_short)

// ============================================================================
// PLOTTING
// ============================================================================
bgcolor(show_signals ? regime_color : na, title="Regime Background")

plotshape(show_signals and valid_long, "Long Signal", shape.triangleup, 
          location.belowbar, color.green, size=size.small)
plotshape(show_signals and valid_short, "Short Signal", shape.triangledown, 
          location.abovebar, color.red, size=size.small)

plot(er, "Efficiency Ratio", color.blue, linewidth=2)
hline(0.7, "Strong Trend", color.green, linestyle=hline.style_dashed)
hline(0.5, "Weak Trend", color.lime, linestyle=hline.style_dotted)
hline(0.3, "Choppy", color.red, linestyle=hline.style_dashed)

// ============================================================================
// TABLE
// ============================================================================
var table stats_table = table.new(position.top_right, 2, 5)

if show_table and barstate.islast
    table.cell(stats_table, 0, 0, "Regime", bgcolor=color.gray, text_color=color.white)
    table.cell(stats_table, 1, 0, regime, bgcolor=regime_color, text_color=color.white)
    table.cell(stats_table, 0, 1, "ER Value", text_color=color.white)
    table.cell(stats_table, 1, 1, str.tostring(er, "#.##"), text_color=color.white)
    table.cell(stats_table, 0, 2, "Strategy", text_color=color.white)
    strategy_text = er > 0.5 ? "Momentum" : er < 0.3 ? "Mean Reversion" : "Stay Out"
    table.cell(stats_table, 1, 2, strategy_text, text_color=color.white)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(valid_long, "Long Signal", "ER Regime: Long Signal")
alertcondition(valid_short, "Short Signal", "ER Regime: Short Signal")
